/*
 *  ad6620.c
 *  Static
 *
 *  Created by Curtis Jones on 2009.12.28.
 *  Copyright 2009 Curtis Jones. All rights reserved.
 *
 */

#include "ad6620.h"
#include "../../misc/logger.h"
#include <stdlib.h>

//
// 5KHz
//
// pass bandwidth: .0025 .001 dB
// stop bandwidth: .004069 -90 dB
//
static ad6620params_t gDec005 = 
{
	16, 32, 16,
	16, 32, 4,
	{
		672, -502, 442, -232, 228, -117, 112, -89, 32, -103, -38, -138, -105, -184, -166, -229,
		-217, -263, -251, -280, -260, -270, -238, -229, -183, -155, -95, -50, 22, 80, 159, 224,
		303, 367, 439, 493, 549, 583, 615, 622, 621, 595, 559, 496, 423, 325, 217, 89,
		-46, -195, -344, -501, -650, -798, -930, -1052, -1149, -1226, -1272, -1291, -1272, -1222, -1132, -1009,
		-847, -654, -428, -177, 98, 387, 687, 988, 1285, 1565, 1826, 2053, 2244, 2385, 2475, 2504,
		2469, 2365, 2193, 1948, 1636, 1257, 819, 326, -210, -782, -1374, -1975, -2569, -3141, -3674, -4153,
		-4559, -4879, -5094, -5193, -5162, -4991, -4670, -4194, -3558, -2763, -1810, -704, 547, 1931, 3436, 5043,
		6735, 8490, 10285, 12097, 13900, 15668, 17376, 18999, 20512, 21891, 23116, 24168, 25031, 25690, 26135, 26359,
		26359, 26135, 25690, 25031, 24168, 23116, 21891, 20512, 18999, 17376, 15668, 13900, 12097, 10285, 8490, 6735,
		5043, 3436, 1931, 547, -704, -1810, -2763, -3558, -4194, -4670, -4991, -5162, -5193, -5094, -4879, -4559,
		-4153, -3674, -3141, -2569, -1975, -1374, -782, -210, 326, 819, 1257, 1636, 1948, 2193, 2365, 2469,
		2504, 2475, 2385, 2244, 2053, 1826, 1565, 1285, 988, 687, 387, 98, -177, -428, -654, -847,
		-1009, -1132, -1222, -1272, -1291, -1272, -1226, -1149, -1052, -930, -798, -650, -501, -344, -195, -46,
		89, 217, 325, 423, 496, 559, 595, 621, 622, 615, 583, 549, 493, 439, 367, 303,
		224, 159, 80, 22, -50, -95, -155, -183, -229, -238, -270, -260, -280, -251, -263, -217,
		-229, -166, -184, -105, -138, -38, -103, 32, -89, 112, -117, 228, -232, 442, -502, 672
	}
};

//
// 10KHz
//
// pass bandwidth: .005 .001 dB
// stop bandwidth: .008138 -90 dB
//
static ad6620params_t gDec010 = 
{
	8, 32, 16,
	8, 32, 4,
	{
		672, -502, 442, -232, 228, -117, 112, -89, 32, -103, -38, -138, -105, -184, -166, -229,
		-217, -263, -251, -280, -260, -270, -238, -229, -183, -155, -95, -50, 22, 80, 159, 224,
		303, 367, 439, 493, 549, 583, 615, 622, 621, 595, 559, 496, 423, 325, 217, 89,
		-46, -195, -344, -501, -650, -798, -930, -1052, -1149, -1226, -1272, -1291, -1272, -1222, -1132, -1009,
		-847, -654, -428, -177, 98, 387, 687, 988, 1285, 1565, 1826, 2053, 2244, 2385, 2475, 2504,
		2469, 2365, 2193, 1948, 1636, 1257, 819, 326, -210, -782, -1374, -1975, -2569, -3141, -3674, -4153,
		-4559, -4879, -5094, -5193, -5162, -4991, -4670, -4194, -3558, -2763, -1810, -704, 547, 1931, 3436, 5043,
		6735, 8490, 10285, 12097, 13900, 15668, 17376, 18999, 20512, 21891, 23116, 24168, 25031, 25690, 26135, 26359,
		26359, 26135, 25690, 25031, 24168, 23116, 21891, 20512, 18999, 17376, 15668, 13900, 12097, 10285, 8490, 6735,
		5043, 3436, 1931, 547, -704, -1810, -2763, -3558, -4194, -4670, -4991, -5162, -5193, -5094, -4879, -4559,
		-4153, -3674, -3141, -2569, -1975, -1374, -782, -210, 326, 819, 1257, 1636, 1948, 2193, 2365, 2469,
		2504, 2475, 2385, 2244, 2053, 1826, 1565, 1285, 988, 687, 387, 98, -177, -428, -654, -847,
		-1009, -1132, -1222, -1272, -1291, -1272, -1226, -1149, -1052, -930, -798, -650, -501, -344, -195, -46,
		89, 217, 325, 423, 496, 559, 595, 621, 622, 615, 583, 549, 493, 439, 367, 303,
		224, 159, 80, 22, -50, -95, -155, -183, -229, -238, -270, -260, -280, -251, -263, -217,
		-229, -166, -184, -105, -138, -38, -103, 32, -89, 112, -117, 228, -232, 442, -502, 672
	}
};

//
// 25KHz
//
// pass bandwidth: .0125 .001 dB
// stop bandwidth: .018896 -90 dB
//
static ad6620params_t gDec025 = 
{
	7, 21, 12,
	7, 21, 4,
	{
		-81, 279, -99, 176, -6, 131, 37, 105, 44, 75, 25, 31, -17, -26, -72, -89,
		-130, -147, -178, -185, -199, -190, -183, -153, -122, -72, -21, 44, 108, 179, 242, 305,
		353, 392, 411, 414, 392, 352, 286, 202, 97, -20, -149, -280, -410, -529, -633, -712,
		-763, -778, -757, -693, -590, -448, -272, -67, 156, 391, 623, 844, 1037, 1195, 1303, 1355,
		1342, 1261, 1110, 892, 612, 281, -90, -483, -881, -1265, -1614, -1908, -2128, -2257, -2283, -2197,
		-1994, -1676, -1250, -730, -134, 514, 1185, 1849, 2471, 3018, 3457, 3757, 3893, 3845, 3600, 3155,
		2513, 1689, 709, -395, -1579, -2795, -3986, -5093, -6055, -6810, -7302, -7479, -7296, -6720, -5728, -4311,
		-2476, -242, 2356, 5268, 8433, 11778, 15221, 18674, 22045, 25242, 28177, 30765, 32933, 34617, 35768, 36352,
		36352, 35768, 34617, 32933, 30765, 28177, 25242, 22045, 18674, 15221, 11778, 8433, 5268, 2356, -242, -2476,
		-4311, -5728, -6720, -7296, -7479, -7302, -6810, -6055, -5093, -3986, -2795, -1579, -395, 709, 1689, 2513,
		3155, 3600, 3845, 3893, 3757, 3457, 3018, 2471, 1849, 1185, 514, -134, -730, -1250, -1676, -1994,
		-2197, -2283, -2257, -2128, -1908, -1614, -1265, -881, -483, -90, 281, 612, 892, 1110, 1261, 1342,
		1355, 1303, 1195, 1037, 844, 623, 391, 156, -67, -272, -448, -590, -693, -757, -778, -763,
		-712, -633, -529, -410, -280, -149, -20, 97, 202, 286, 352, 392, 414, 411, 392, 353,
		305, 242, 179, 108, 44, -21, -72, -122, -153, -183, -190, -199, -185, -178, -147, -130,
		-89, -72, -26, -17, 31, 25, 75, 44, 105, 37, 131, -6, 176, -99, 279, -81
	}
};

//
// 50KHz
//
// pass bandwidth: .025 .001 dB
// stop bandwidth: .037792 -90 dB
//
static ad6620params_t gDec050 = 
{
	8, 30, 5,
	8, 30, 4,
	{
		-115, 572, 286, 894, 855, 1164, 1031, 971, 601, 278,-156,-424,-607,-546,-363,-34 ,
		269, 511, 560, 445, 158,-174,-474,-610,-558,-300, 62, 431, 663, 689, 471, 88 ,
		-355,-694,-821,-668,-282, 228, 686, 938, 880, 519,-44,-622,-1023,-1093,-794,-202 ,
		491, 1058, 1291, 1097, 511,-282,-1025,-1457,-1414,-880,-14, 908, 1568, 1727, 1299, 401 ,
		-689,-1602,-2017,-1759,-880, 353, 1536, 2258, 2242, 1452, 113,-1343,-2423,-2728,-2110,-724 ,
		997, 2479, 3195, 2849, 1494,-465,-2390,-3612,-3661,-2442,-292, 2109, 3946, 4541, 3597, 1330 ,
		-1574,-4154,-5488,-5011,-2740, 688, 4177, 6519, 6787, 4690, 724,-3918,-7684,-9155,-7544,-3033 ,
		3174, 9131, 12703, 12256, 7260,-1366,-11320,-19399,-22305,-17564,-4306, 16319, 41233, 66039, 85987, 97095 ,
		97095, 85987, 66039, 41233, 16319,-4306,-17564,-22305,-19399,-11320,-1366, 7260, 12256, 12703, 9131, 3174 ,
		-3033,-7544,-9155,-7684,-3918, 724, 4690, 6787, 6519, 4177, 688,-2740,-5011,-5488,-4154,-1574 ,
		1330, 3597, 4541, 3946, 2109,-292,-2442,-3661,-3612,-2390,-465, 1494, 2849, 3195, 2479, 997 ,
		-724,-2110,-2728,-2423,-1343, 113, 1452, 2242, 2258, 1536, 353,-880,-1759,-2017,-1602,-689 ,
		401, 1299, 1727, 1568, 908,-14,-880,-1414,-1457,-1025,-282, 511, 1097, 1291, 1058, 491 ,
		-202,-794,-1093,-1023,-622,-44, 519, 880, 938, 686, 228,-282,-668,-821,-694,-355 ,
		88, 471, 689, 663, 431, 62,-300,-558,-610,-474,-174, 158, 445, 560, 511, 269 ,
		-34,-363,-546,-607,-424,-156, 278, 601, 971, 1031, 1164, 855, 894, 286, 572,-115
	}
};

//
// 100KHz
//
// pass bandwidth: .0125 .001 dB
// stop bandwidth: .018896 -90 dB
//
static ad6620params_t gDec100 = 
{
	5, 30, 4,
	5, 30, 4,
	{
		111, 108, 197, 150, 69,-150,-405,-679,-847,-866,-689,-380,-23, 244, 337, 222, 
		-27,-290,-429,-371,-131, 176, 402, 426, 227,-107,-406,-515,-361,-8, 374, 586 ,
		504, 149,-309,-639,-655,-326, 199, 657, 801, 531,-39,-630,-929,-758,-173, 545 ,
		1024, 994, 435,-394,-1071,-1227,-742, 170, 1054, 1438, 1085, 131,-956,-1608,-1449,-509, 765 ,
		1716, 1818, 959,-467,-1739,-2170,-1474, 53, 1653, 2479, 2038, 481,-1436,-2717,-2634,-1140 ,
		1064, 2851, 3238, 1922,-515,-2847,-3823,-2822,-237, 2665, 4354, 3835, 1218,-2256,-4793,-4956 ,
		-2465, 1563, 5093, 6183, 4030,-501,-5191,-7525,-6007,-1062, 5000, 9018, 8574, 3371,-4365,-10755 ,
		-12118,-6953, 2955, 12982, 17627, 13228, 184,-16444,-28453,-27679,-9595, 24220, 65916, 103759, 126224, 126224 ,
		103759, 65916, 24220,-9595,-27679,-28453,-16444, 184, 13228, 17627, 12982, 2955,-6953,-12118,-10755,-4365 ,
		3371, 8574, 9018, 5000,-1062,-6007,-7525,-5191,-501, 4030, 6183, 5093, 1563,-2465,-4956,-4793 ,
		-2256, 1218, 3835, 4354, 2665,-237,-2822,-3823,-2847,-515, 1922, 3238, 2851, 1064,-1140,-2634 ,
		-2717,-1436, 481, 2038, 2479, 1653, 53,-1474,-2170,-1739,-467, 959, 1818, 1716, 765,-509 ,
		-1449,-1608,-956, 131, 1085, 1438, 1054, 170,-742,-1227,-1071,-394, 435, 994, 1024, 545 ,
		-173,-758,-929,-630,-39, 531, 801, 657, 199,-326,-655,-639,-309, 149, 504, 586 ,
		374,-8,-361,-515,-406,-107, 227, 426, 402, 176,-131,-371,-429,-290,-27, 222 ,
		337, 244,-23,-380,-689,-866,-847,-679,-405,-150, 69, 150, 197, 108, 111
	}
};

//
// 150KHz
//
// pass bandwidth: ?
// stop bandwidth: ?
//
static ad6620params_t gDec150 = 
{
	5, 28, 3,
	5, 28, 4,
	{
		80,-1272,-1501,-2506,-1995,-1237, 225, 985, 1065, 218,-585,-897,-355, 403, 811, 432 ,
		-300,-777,-504, 221, 771, 585,-145,-776,-676, 61, 783, 777, 36,-784,-884,-149 ,
		774, 996, 279,-749,-1108,-427, 706, 1217, 591,-641,-1321,-772, 553, 1415, 968,-437 ,
		-1496,-1177, 293, 1560, 1398,-119,-1602,-1628,-87, 1620, 1863, 325,-1608,-2101,-598, 1562 ,
		2339, 905,-1478,-2571,-1247, 1350, 2793, 1624,-1175,-3001,-2036, 947, 3190, 2484,-660,-3353 ,
		-2967, 307, 3484, 3486, 118,-3575,-4042,-626, 3619, 4637, 1227,-3606,-5273,-1936, 3523, 5956 ,
		2775,-3354,-6694,-3770, 3080, 7501, 4965,-2669,-8398,-6426, 2076, 9422, 8256,-1227,-10635,-10642 ,
		-11, 12151, 13929, 1901,-14192,-18856,-5052, 17262, 27312, 11251,-22720,-45866,-28628 ,
		35237, 119172, 178193, 178193, 119172, 35237,-28628,-45866,-22720, 11251, 27312, 17262,-5052,-18856,-14192, 1901 ,
		13929, 12151,-11,-10642,-10635,-1227, 8256, 9422, 2076,-6426,-8398,-2669, 4965, 7501, 3080,-3770 ,
		-6694,-3354, 2775, 5956, 3523,-1936,-5273,-3606, 1227, 4637, 3619,-626,-4042,-3575, 118, 3486 ,
		3484, 307,-2967,-3353,-660, 2484, 3190, 947,-2036,-3001,-1175, 1624, 2793, 1350,-1247,-2571 ,
		-1478, 905, 2339, 1562,-598,-2101,-1608, 325, 1863, 1620,-87,-1628,-1602,-119, 1398, 1560 ,
		293,-1177,-1496,-437, 968, 1415, 553,-772,-1321,-641, 591, 1217, 706,-427,-1108,-749 ,
		279, 996, 774,-149,-884,-784, 36, 777, 783, 61,-676,-776,-145, 585, 771, 221 ,
		-504,-777,-300, 432, 811, 403,-355,-897,-585, 218, 1065, 985, 225,-1237,-1995,-2506 ,
		-1501,-1272, 80
	}
};

//
// 190KHz
//
static ad6620params_t gDec190 =
{
	10, 17, 2,
	10, 17, 4,
	{
		3447 ,-2833 ,-1187 ,-2836 , 784 ,-262 ,-551 ,-1155 , 655 , 341 ,-484 ,-824 , 627 , 573 ,-493 ,-814 ,
		597 , 739 ,-495 ,-905 , 556 , 899 ,-472 ,-1036 , 498 , 1065 ,-419 ,-1189 , 417 , 1238 ,-335 ,-1355 ,
		308 , 1416 ,-219 ,-1527 , 167 , 1595 ,-66 ,-1700 ,-8 , 1771 , 124 ,-1870 ,-221 , 1939 , 355 ,-2031 ,
		-475 , 2096 , 628 ,-2177 ,-772 , 2235 , 946 ,-2304 ,-1114 , 2350 , 1310 ,-2404 ,-1504 , 2435 , 1723 ,-2470 ,
		-1944 , 2482 , 2188 ,-2494 ,-2436 , 2483 , 2707 ,-2468 ,-2984 , 2429 , 3285 ,-2381 ,-3593 , 2308 , 3925 ,-2221 ,
		-4268 , 2107 , 4635 ,-1974 ,-5017 , 1808 , 5426 ,-1618 ,-5854 , 1390 , 6314 ,-1128 ,-6799 , 819 , 7322 ,-465 ,
		-7882 , 50 , 8492 , 429 ,-9154 ,-993 , 9888 , 1653 ,-10702 ,-2438 , 11626 , 3378 ,-12684 ,-4524 , 13926 , 5947 ,
		-15415 ,-7763 , 17256 , 10157 ,-19614 ,-13468 , 22786 , 18349 ,-27322 ,-26280 , 34392 , 41334 ,-46742 ,-79378 , 69315 , 263870 ,
		263870 , 69315 ,-79378 ,-46742 , 41334 , 34392 ,-26280 ,-27322 , 18349 , 22786 ,-13468 ,-19614 , 10157 , 17256 ,-7763 ,-15415 ,
		5947 , 13926 ,-4524 ,-12684 , 3378 , 11626 ,-2438 ,-10702 , 1653 , 9888 ,-993 ,-9154 , 429 , 8492 , 50 ,-7882 ,
		-465 , 7322 , 819 ,-6799 ,-1128 , 6314 , 1390 ,-5854 ,-1618 , 5426 , 1808 ,-5017 ,-1974 , 4635 , 2107 ,-4268 ,
		-2221 , 3925 , 2308 ,-3593 ,-2381 , 3285 , 2429 ,-2984 ,-2468 , 2707 , 2483 ,-2436 ,-2494 , 2188 , 2482 ,-1944 ,
		-2470 , 1723 , 2435 ,-1504 ,-2404 , 1310 , 2350 ,-1114 ,-2304 , 946 , 2235 ,-772 ,-2177 , 628 , 2096 ,-475 ,
		-2031 , 355 , 1939 ,-221 ,-1870 , 124 , 1771 ,-8 ,-1700 ,-66 , 1595 , 167 ,-1527 ,-219 , 1416 , 308 ,
		-1355 ,-335 , 1238 , 417 ,-1189 ,-419 , 1065 , 498 ,-1036 ,-472 , 899 , 556 ,-905 ,-495 , 739 , 597 ,
		-814 ,-493 , 573 , 627 ,-824 ,-484 , 341 , 655 ,-1155 ,-551 ,-262 , 784 ,-2836 ,-1187 ,-2833 , 3447 
	}
};





#pragma mark -
#pragma mark structors

/**
 *
 *
 */
int
ad6620_init (ad6620_t *ad6620, opool_t *pool)
{
	int error;
	
	if (unlikely(ad6620 == NULL))
		LOG_ERROR_AND_RETURN(-1, "null ad6620_t");
	
	if (unlikely(0 != (error = chip_init((chip_t*)ad6620, CHIP_AD6620, "chip::ad6620", (cobject_destroy_func)ad6620_destroy, pool))))
		LOG_ERROR_AND_RETURN(-101, "failed to chip_init, %d", error);
	
	return 0;
}

/**
 *
 *
 */
int
ad6620_destroy (ad6620_t *ad6620)
{
	int error;
	
	if (unlikely(ad6620 == NULL))
		LOG_ERROR_AND_RETURN(-1, "null ad6620_t");
	
	if (unlikely(0 != (error = chip_destroy((chip_t*)ad6620))))
		LOG_ERROR_AND_RETURN(-101, "failed to chip_destroy, %d", error);
	
	return 0;
}





#pragma mark -
#pragma mark accessors

/**
 *
 *
 */
inline chip_t*
ad6620_chip (ad6620_t *ad6620)
{
	return (chip_t*)ad6620;
}

/**
 *
 *
 */
int
ad6620_stdcoeffs (ad6620_t *ad6620, uint32_t span)
{
	ad6620params_t *params;
	
	if (unlikely(ad6620 == NULL))
		LOG_ERROR_AND_RETURN(-1, "null ad6620_t");
	
	     if (  5 == span) params = &gDec005;
	else if ( 10 == span) params = &gDec010;
	else if ( 25 == span) params = &gDec025;
	else if ( 50 == span) params = &gDec050;
	else if (100 == span) params = &gDec100;
	else if (150 == span) params = &gDec150;
	else if (190 == span) params = &gDec190;
	else
		LOG_ERROR_AND_RETURN(-101, "unsupported span, %u", span);
	
	memcpy(&ad6620->params, params, sizeof(ad6620params_t));
	
	return 0;
}





#pragma mark -
#pragma mark cobject stuff

/**
 *
 *
 */
inline ad6620_t*
ad6620_retain (ad6620_t *ad6620)
{
	if (unlikely(ad6620 == NULL))
		LOG_ERROR_AND_RETURN(NULL, "null ad6620_t");
	
	return (ad6620_t*)chip_retain((chip_t*)ad6620);
}

/**
 *
 *
 */
inline void
ad6620_release (ad6620_t *ad6620)
{
	if (unlikely(ad6620 == NULL))
		LOG_ERROR_AND_RETURN(, "null ad6620_t");
	
	chip_release((chip_t*)ad6620);
}
